name: üöÄ CI - GeoNova
# Pipeline de Integraci√≥n Continua para GeoNova
# Validaci√≥n autom√°tica de calidad, tests y build

on:
  push:
    branches: [main]
    # Se ejecuta en cada push a main
  pull_request:
    branches: [main]
    # Se ejecuta en Pull Requests hacia main
  workflow_dispatch:
    # Permite ejecuci√≥n manual desde GitHub Actions UI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
  # Cancela ejecuciones duplicadas en la misma rama para ahorrar recursos

jobs:
  # ============================================
  # JOB 1: VERIFICACI√ìN DE CALIDAD DE C√ìDIGO
  # ============================================
  quality-checks:
    name: üîç Calidad de C√≥digo
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
        # Descarga el c√≥digo del repositorio

      - name: üîß Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          # Lee la versi√≥n de Node desde .nvmrc (actualmente Node 20)
          cache: npm
          # Cache de node_modules para acelerar instalaciones

      - name: üì¶ Instalar dependencias
        run: npm ci
        # npm ci instala desde package-lock.json (m√°s r√°pido y reproducible que npm install)

      - name: üß† Verificar tipos con TypeScript
        run: npm run type-check
        # Ejecuta tsc --noEmit para validar tipos sin generar archivos

      - name: üßπ Analizar c√≥digo con ESLint
        run: npm run lint
        # Verifica que el c√≥digo siga las reglas de ESLint (m√°ximo 0 warnings)

  # ============================================
  # JOB 2: PRUEBAS UNITARIAS
  # ============================================
  tests:
    name: üß™ Pruebas Unitarias
    runs-on: ubuntu-latest
    needs: quality-checks
    # Este job solo se ejecuta si quality-checks es exitoso
    permissions:
      contents: read
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: üîß Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: üì¶ Instalar dependencias
        run: npm ci

      - name: üß™ Ejecutar tests con Jest
        run: npm test -- --ci --coverage
        # --ci: modo CI (sin interactividad)
        # --coverage: genera reporte de cobertura de c√≥digo

      - name: üìä Subir reporte de cobertura
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          retention-days: 30
          # El reporte se guarda por 30 d√≠as y luego se borra autom√°ticamente

  # ============================================
  # JOB 3: BUILD DE PRODUCCI√ìN
  # ============================================
  build:
    name: üèóÔ∏è Build de Producci√≥n
    runs-on: ubuntu-latest
    needs: [quality-checks, tests]
    # Solo se ejecuta si AMBOS jobs anteriores son exitosos
    permissions:
      contents: read
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: üîß Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: üì¶ Instalar dependencias
        run: npm ci

      - name: üèóÔ∏è Compilar proyecto con Vite
        run: npm run build
        # Genera la carpeta dist/ optimizada para producci√≥n

      - name: ‚úÖ Verificar integridad del build
        run: |
          echo "üîç Verificando que el build se gener√≥ correctamente..."
          
          if [ ! -d "dist" ]; then
            echo "‚ùå ERROR: La carpeta dist no fue generada"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå ERROR: index.html no encontrado en dist"
            exit 1
          fi
          
          echo "‚úÖ Build generado correctamente"
          echo "üìä Tama√±o total del build:"
          du -sh dist
          
          echo "üìÅ Archivos principales generados:"
          ls -lh dist/ | grep -E '\.(html|js|css)$' || echo "No se encontraron archivos principales"
        # Verifica que la carpeta dist existe y contiene los archivos esperados

      - name: üì§ Subir build de producci√≥n
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: geonova-production-build
          # Nombre descriptivo del artifact
          path: dist
          retention-days: 30
          # Se guarda por 30 d√≠as (√∫til para rollbacks o debugging)

  # ============================================
  # JOB 4: PREVIEW DEL BUILD (solo en PRs)
  # ============================================
  deploy-preview:
    name: üöÄ Preview del Build
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    # Este job SOLO se ejecuta en Pull Requests, no en push a main
    permissions:
      contents: read
    
    steps:
      - name: üì• Descargar build de producci√≥n
        uses: actions/download-artifact@v4
        with:
          name: geonova-production-build
          path: dist
        # Descarga el artifact generado en el job anterior

      - name: üìã Generar resumen del build
        run: |
          echo "### üéâ Build de GeoNova completado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üì¶ Tama√±o total del build:**" >> $GITHUB_STEP_SUMMARY
          du -sh dist >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üìÅ Archivos principales generados:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‚úÖ El build est√° listo para desplegar**" >> $GITHUB_STEP_SUMMARY
        # Genera un resumen visual en la pesta√±a "Summary" de GitHub Actions
        # Esto facilita revisar el estado del build sin entrar a los logs

# ============================================
# NOTAS IMPORTANTES
# ============================================
# 
# 1. Este workflow ejecuta 4 jobs en orden:
#    - quality-checks: TypeScript + ESLint
#    - tests: Jest + Cobertura
#    - build: Vite build + Validaci√≥n
#    - deploy-preview: Resumen (solo PRs)
#
# 2. Si alg√∫n job falla, los siguientes no se ejecutan (ahorra tiempo y recursos)
#
# 3. Los artifacts (build + coverage) se guardan por 30 d√≠as
#
# 4. El job "deploy-preview" solo se ejecuta en Pull Requests
#    para no saturar con informaci√≥n en cada push a main
#
# 5. Puedes ejecutar este workflow manualmente desde:
#    GitHub ‚Üí Actions ‚Üí CI - GeoNova ‚Üí Run workflow